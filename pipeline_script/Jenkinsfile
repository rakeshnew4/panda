pipeline {
    agent {
        kubernetes {
            yaml """
apiVersion: v1
kind: Pod
metadata:
  labels:
    some-label: my-pipeline-pod
spec:
  containers:
  - name: dockerindocker
    image: docker:24.0-dind
    securityContext:
      privileged: true
    command:
    - dockerd-entrypoint.sh
    args:
    - --host=tcp://0.0.0.0:2375
    - --host=unix:///var/run/docker.sock
    volumeMounts:
    - name: docker-sock
      mountPath: /var/run/docker.sock
  volumes:
  - name: docker-sock
    emptyDir: {}
"""
        }
    }
    stages {
        stage("Deploy") {
            steps {
                container("dockerindocker") {
                    sh """
                    # Ensure Docker daemon is running
                    dockerd &
                    sleep 5  # Wait for the Docker daemon to initialize
                    docker info  # Verify Docker daemon is accessible
                    
                    # Build Docker image
                    docker build -t 058264520519.dkr.ecr.us-east-1.amazonaws.com/panda:v1 .
                    """
                    echo "Docker image built successfully!"
                }
            }
        }
    }
}
